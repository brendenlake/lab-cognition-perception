
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 3: fMRI and Multiple Comparisons &#8212; Lab in C&amp;P (Fall 2021)</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nyustyle.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/artificialintelligence.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Lab in C&P (Fall 2021)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../course-content/syllabus.html">
   Syllabus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../course-content/schedule.html">
   Schedule
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Resources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://edstem.org/us/courses/8295/discussion/">
   EdStem
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Textbook
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/00/00-cogsci.html">
   1. What is Cognitive Science and how do we study it?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/01/00-whystats.html">
   2. Why do we have to learn statistics?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/02/00-jupyter.html">
   3. Introduction to Jupyter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/03/00-python.html">
   4. Intro to Python for Psychology Undergrads
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/04/00-researchdesign.html">
   5. A brief introduction to research design
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/05/00-data.html">
   6. The Format and Structure of Digital Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/06/00-plots.html">
   7. Visualizing Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/07/00-describingdata.html">
   8. Describing Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/08/01-sampling.html">
   9. Samples, populations and sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/09/00-hypothesistesting.html">
   10. Hypothesis testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/10/00-ttest.html">
   11. Comparing one or two means
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/11/00-inferences-from-behavior.html">
   12. Measuring Behavior
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/21/00-ethics-irb.html">
   13. Research Ethics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/13/00-linearregression.html">
   14. Linear regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/14/00-logisticregression.html">
   15. Logistic regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/15/00-mixed-effect.html">
   16. Linear Mixed Effect Modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/16/00-mentalsimulation.html">
   17. Mental Imagery, Mental Simulation, and Mental Rotation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/17/00-mri.html">
   18. Magnetic Resonance Imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/24/00-what-next.html">
   19. What Next?
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Labs &amp; Homeworks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapters/00/cogsci-ica.html">
   Intro to CogSci ICA
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../homeworks/Homework1.html">
   Intro to Jupyter (HW1)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tips &amp; Tricks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../tips/pythonresources.html">
   Python Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tips/plottingresources.html">
   Plotting in Python Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tips/fortyforloops.html">
   Intro to For loops
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tips/nyu-jupyterhub.html">
   NYU JupyterHub Setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tips/ultimate-guide-ttest-python.html">
   Ultimate t-test guide
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  About
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../LICENSE.html">
   License
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/labs/LabReg-MRI-Pt1.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        
        <a class="jupyterhub-button" href="https://psychua-46-fall.rcnyu.org//hub/user-redirect/git-pull?repo=https://github.com/executablebooks/jupyter-book&urlpath=tree/jupyter-book/labs/LabReg-MRI-Pt1.ipynb&branch=master"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="../_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction-to-mri-data">
   Introduction to MRI data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loading-data">
   Loading data.
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#indexing-numpy-arrays">
   Indexing numpy arrays
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#timecourse-of-activation-for-a-single-voxel">
   Timecourse of activation for a single voxel
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#voxel-timecourses-and-correlation">
   Voxel timecourses and correlation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#relating-brain-data-to-the-experimental-protocol">
   Relating brain data to the experimental protocol
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">display</span>

<span class="kn">import</span> <span class="nn">numpy.random</span> <span class="k">as</span> <span class="nn">npr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">nibabel</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gamma</span>

<span class="c1"># Enable plots inside the Jupyter Notebook</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="section" id="lab-3-fmri-and-multiple-comparisons">
<h1>Lab 3: fMRI and Multiple Comparisons<a class="headerlink" href="#lab-3-fmri-and-multiple-comparisons" title="Permalink to this headline">¶</a></h1>
<p>Authored by <em>Shannon Tubridy</em>, <em>Hillary Raab</em>, and <em>Todd Gureckis</em><br />
Aspects borrowed from <a class="reference external" href="https://github.com/akcarsten/fMRI_data_analysis">Carsten Klein’s Intro to fMRI analysis in Python</a>.</p>
<p>This lab will introduce you to manipulating fMRI data in python and will apply the correlation and regression concepts from previous sections</p>
<div class="section" id="introduction-to-mri-data">
<h2>Introduction to MRI data<a class="headerlink" href="#introduction-to-mri-data" title="Permalink to this headline">¶</a></h2>
<p>MRI scanners can be used to create 3D images. The scanners can be tuned to be sensitive to different kinds of physical materials present in the object (like a brain) being imaged.</p>
<p>The two primary image types that are used in cognitive neuroscience are <strong>structural</strong> (sometimes called <strong>anatomical</strong>) and <strong>functional</strong> images.</p>
<img src="./images/brain_basics.svg"><p>Structural images provide information about the anatomy of what’s being imaged by showing differences between different kinds of tissues, bone, cerebro-spinal fluid and so on. A structural MRI image is a relatively high spatial resolution (compared to fMRI) 3D image that can be used to assess the internal anatomy of individual brains.</p>
<p>Functional MRI scans produce a set of 3D images recorded over time. These images are lower spatial resolution than structual images. But unlike structural images, fMRI scans measure a signal that is related to neural activity.</p>
<p>The BOLD signal commonly measured with fMRI is a time-varying signal modulated by changes in the oxygen content of blood. For people interested in the brain and behavior this is useful because that change in the oxygen content of blood is related to neural activity.</p>
<p>This means that researchers can record the BOLD signal from locations throughout the brain while people engage in a variety of cognitive and perceptual tasks. By assessing whether the BOLD fMRI signal in different brain areas changes in response to changes in people’s perceptual or cognitive states researchers are able to make advances in understanding how our brains produce our thoughts and behavior.</p>
<p>Let’s get into some data.</p>
</div>
<div class="section" id="loading-data">
<h2>Loading data.<a class="headerlink" href="#loading-data" title="Permalink to this headline">¶</a></h2>
<p>First we start with importing the libraries for downloading, organizing and visualizing the data which comes from the SPM homepage (http://www.fil.ion.ucl.ac.uk/spm/). SPM is a popular Matlab Toolbox for analyzing fMRI brain imaging data and on their homepage some example datasets are provided.</p>
<p>(There are a number of data pre=processing steps involved in going from the MRI scanner to the data we’re going to download here. These primarily have to do with accounting for distortions, artifacts, or other unwanted contaminations of the signal of interest. Although those preprocessing steps are crucial for the kinds of data examined in this notebook, they tend to be less related to questions about cognition and perception and so we’ll jump ahead.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the URL of the data and download it using the Requests libary</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://www.fil.ion.ucl.ac.uk/spm/download/data/MoAEpilot/MoAEpilot.zip&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="c1"># this notebook needs to download ~100MB of data into the path listed in destination_dir</span>
<span class="n">destination_dir</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>

<span class="c1"># Check if the targed folder for storing the data already exists. If not create it and save the zip file.</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination_dir</span> <span class="o">+</span> <span class="s1">&#39;/fMRI_data/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_dir</span> <span class="o">+</span> <span class="s1">&#39;/fMRI_data/&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;destination_dir &#39;</span> <span class="o">+</span> <span class="n">destination_dir</span> <span class="o">+</span> <span class="s1">&#39; doesn&#39;&#39;t exist and/or it can&#39;&#39;t be created&#39;</span><span class="p">)</span>
    
<span class="nb">open</span><span class="p">(</span><span class="n">destination_dir</span> <span class="o">+</span> <span class="s1">&#39;/fMRI_data/&#39;</span> <span class="o">+</span> <span class="s1">&#39;data.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

<span class="c1"># Un-zip the file</span>
<span class="n">zip_ref</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">destination_dir</span> <span class="o">+</span> <span class="s1">&#39;/fMRI_data/&#39;</span> <span class="o">+</span> <span class="s1">&#39;data.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">destination_dir</span> <span class="o">+</span> <span class="s1">&#39;/fMRI_data/&#39;</span><span class="p">)</span>
<span class="n">zip_ref</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at what we downloaded. In the cell above we set the destination directory to be the directory that this notebook is running from (the <code class="docutils literal notranslate"><span class="pre">'.'</span></code> from up above) and we created a subfolder inside of there called <code class="docutils literal notranslate"><span class="pre">/fmri_data/</span></code> using os.makedirs.</p>
<p>Navigate to the finder and go to the directory where this notebook lives and take a look.</p>
<p>As you can see un-zipping the file gives us two folders with various files inside them. The first folder (“./sM00223/”) contains a high resolution structural scan of the subject.</p>
<p>The functional data is located in the other folder (“./fM00223/”).</p>
<p>You’ll notice that there pairs of files in these folders. These pairs have the same filename but one has the extension .hdr and the other has the exenstion .img. The .hdr is a file that contains meta-information related to the MRI data collection and the .img files have the actual MRI data inside.</p>
<p>The NiBabel provides tools for using python to read and write MRI-related file types like <code class="docutils literal notranslate"><span class="pre">.hdr</span></code>, <code class="docutils literal notranslate"><span class="pre">.img</span></code>, and <code class="docutils literal notranslate"><span class="pre">.nii</span></code>.</p>
<p>First lets read in the structural data using the the NiBabel package.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find all files in the structural data folder</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">destination_dir</span> <span class="o">+</span> <span class="s1">&#39;/fMRI_data/&#39;</span> <span class="o">+</span> <span class="s1">&#39;sM00223/&#39;</span>
<span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">))</span>

<span class="c1"># take a look at what files are listed:</span>
<span class="nb">print</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

<span class="c1"># Read in the data by looping over the list of files and if the last three characters in the name are hdr</span>
<span class="c1"># then we will use nibabel to load the data</span>
<span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="c1"># chec</span>
    <span class="k">if</span> <span class="n">data_file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;hdr&#39;</span><span class="p">:</span>
        <span class="n">structural_data</span> <span class="o">=</span> <span class="n">nibabel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="n">data_file</span><span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;sM00223_002.hdr&#39;, &#39;sM00223_002.img&#39;]
</pre></div>
</div>
</div>
</div>
<p>Now lets load the functional data.</p>
<p>There is a README.txt file that comes with the dataset. The README.txt includes details of the data acquisition which we need to read the files. The key parameters we have to know are the size of each image, the number of slices that were collected and how many volumes were acquired; that is the number of timepoints that were sampled.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic information about the data acquisition</span>
<span class="c1"># how big is the x dimension?</span>
<span class="n">x_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="c1"># how big is the y dimension?</span>
<span class="n">y_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="c1"># how big is the z dimension (called slices here)?</span>
<span class="n">z_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="c1"># How many volumes were collected? It&#39;s one volume per timepoint, so this is also how many </span>
<span class="c1"># timepoints we have in our functional data</span>
<span class="n">n_volumes</span> <span class="o">=</span> <span class="mi">96</span>

<span class="c1"># Find all files in the data functional data folder</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">destination_dir</span> <span class="o">+</span> <span class="s1">&#39;/fMRI_data/&#39;</span> <span class="o">+</span> <span class="s1">&#39;/fM00223/&#39;</span>
<span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">))</span>

<span class="c1"># Read in the data and organize it with respect to the acquisition parameters</span>
<span class="c1"># The data are stored as one volume with dimensions 64x64x64 for each timepoint</span>
<span class="c1"># We will loop over the files, load them one at a time using nibabel storing the single </span>
<span class="c1"># timepoint data in `data`, and appending each timepoint to `data_all` so that we end up with </span>
<span class="c1"># a list of numpy arrays</span>
<span class="n">data_all</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">data_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">data_file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;hdr&#39;</span> <span class="ow">and</span> <span class="n">data_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">nibabel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="n">data_file</span><span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>        
        <span class="n">data_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">z_size</span><span class="p">))</span>
        
<span class="c1"># do some bookkeeping and index swapping so that end up with a 4D numpy array with dimensions</span>
<span class="c1"># x,y,z, and time</span>
<span class="n">functional_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_all</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="c1"># rotate into same alignment as struct image</span>
<span class="n">functional_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">functional_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We have loaded our MRI data loaed and we have stored them in numpy arrays.</p>
<p>Numpy arrays are a way to store data in python. You have seen them before here and there in previous sections but we will make extensive use of them in this section so let’s orient ourselves.</p>
<p>A numpy array has <span class="math notranslate nohighlight">\(N\)</span> dimensions, and each of the dimensions can have some number of elements stored inside of it.</p>
<p>That description is kind of abstract so let’s make it concrete.</p>
<p>Here is the image from the introduction to this notebook.</p>
<img src="./images/brain_basics.svg">
<p>Take a look at the schematic of the structural data.</p>
<p>The data are three dimensional because we have created an image of a three dimensional object. For the structural data we can think about three spatial dimensions <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>,  <span class="math notranslate nohighlight">\(z\)</span>.</p>
<p>The large 3D box that covers the whole head is called a <em><strong>volume</strong></em>.</p>
<p>If you look again at the example illustration you’ll see that each dimension of the volume is segmented into a number of smaller boxes or voxels. The number of voxels along each dimension is the length of that dimension.</p>
<p>In this illustration the length of each dimension is nine voxels, so the total number of voxels in the volume is 9 x 9 x 9 (length x width x height….)</p>
<p>We can check the dimensions of our actual data array using <code class="docutils literal notranslate"><span class="pre">shape</span></code> like we did with data frames. Data frames are 2 dimensional and the number of elements per dimension corresponds to the number of rows and columns.</p>
<p>Let’s see what the shape of our structural data is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">structural_data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(256, 256, 54, 1)
</pre></div>
</div>
</div>
</div>
<p>This output tells us that we have four dimensions to our data.</p>
<p>The first three are the spatial dimensions (so our 3D box is 256 x 256 x 54 voxels in size). The fourth dimension is time <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>One way to think about this is that there is a 3D array of size 256x256x54 covering the brain and there is a version of this box for every element in the fourth dimension of time.</p>
<p>For the structural image there is only data for a single timepoint because we are recording the overall structure of the brain which does not change from moment to moment.</p>
<p>For convenience we can get rid of the fourth dimension because it doesn’t have any information. We’ll use a numpy method called squeeze, which basically flattens any dimensions that have length == 1 and at the same time we’ll rotate the image 90 degrees for viewing purposes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">structural_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">structural_data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># now let&#39;s check the shape again:</span>
<span class="n">structural_data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(256, 256, 54)
</pre></div>
</div>
</div>
</div>
<p>OK, now we have our structural data in a single 3D array just like in the illustration.</p>
<div class="alert alert-info" role="alert">
  <strong>Question 1</strong> <br>
    The `functional_data` is also in a numpy array. What is the shape of the functional_data array? How many timepoints are in the functional data?
</div><div class="alert alert-warning" role="alert">
  <strong>Your Answer</strong> <br>
  Delete this text and put your answer here.
</div></div>
<div class="section" id="indexing-numpy-arrays">
<h2>Indexing numpy arrays<a class="headerlink" href="#indexing-numpy-arrays" title="Permalink to this headline">¶</a></h2>
<p>The value of individual elements in a numpy array can be obtained by giving the appropriate indices. In both our structural and functional MRI data every voxel has a position in the <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, <span class="math notranslate nohighlight">\(z\)</span> space defined by the three spatial axes.</p>
<p>Let’s look at the value of a voxel from the structural image:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_coordinate</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">y_coordinate</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">z_coordinate</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">one_voxel_value</span> <span class="o">=</span> <span class="n">structural_data</span><span class="p">[</span><span class="n">x_coordinate</span><span class="p">,</span> <span class="n">y_coordinate</span><span class="p">,</span> <span class="n">z_coordinate</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">one_voxel_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<p>Ok… so the value of that voxel is 2. What can we do with that number? On its own we can’t do much, but by looking at the values of many voxels at once we can begin to look at images of our data.</p>
<p>The data are 3D, so we cannot directly view an image of the whole 3D array, so instead we will look at <em><strong>slices</strong></em> through the volume.</p>
<p>In the illustration of structural and functional data that we’ve been looking there is an example of a slice shown in orange.</p>
<p>Slicing the data like this means taking all of the values in two of the dimensions for a single location in the remaining dimension. In the illustration the orange slice is all of the elements of the <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(z\)</span> dimensions for a fixed value of <span class="math notranslate nohighlight">\(x\)</span>.</p>
<p>In the indexing example above we gave a single coordinate or index value for each of the x,y, and z dimensions, but we can also easily take all of the values from a dimension using <code class="docutils literal notranslate"><span class="pre">:</span></code> as shown in the cell below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make a numpy array of sequential numbers</span>
<span class="n">my_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

<span class="c1"># check the shape</span>
<span class="nb">print</span><span class="p">(</span><span class="n">my_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># ok there is only one dimension and it has 12 elements in it</span>
<span class="c1"># as is usual in python the elements in each dimension are indexed starting at zero</span>
<span class="c1"># let&#39;s take a look at the first element of my_array</span>
<span class="n">first_element</span> <span class="o">=</span> <span class="n">my_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the first element is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">first_element</span><span class="p">))</span>

<span class="c1"># how about the fifth element?</span>
<span class="n">fifth_element</span> <span class="o">=</span> <span class="n">my_array</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the first element is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fifth_element</span><span class="p">))</span>

<span class="c1"># and now let&#39;s take all of the elements using the `:` indexer</span>
<span class="n">all_elements</span> <span class="o">=</span> <span class="n">my_array</span><span class="p">[:]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;all the elements in the array:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_elements</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(12,)
the first element is 0
the first element is 4
all the elements in the array:
[ 0  1  2  3  4  5  6  7  8  9 10 11]
</pre></div>
</div>
</div>
</div>
<p>Now let’s try viewing 2D slices of our structural data.</p>
<p>Take a look at the code in the next cell at the line starting with <code class="docutils literal notranslate"><span class="pre">ax.imshow</span></code> and see if you can figure out what’s going on with the structural_data array.</p>
<p>In that line we are taking all of the elements in the first two dimensions for a single position in the third dimension specified in the variable <code class="docutils literal notranslate"><span class="pre">slice</span></code>.</p>
<p>This little widget allows you to drag the slider to change the slice that we are taking, letting us move back and forth through the brain viewing a series of 2D views.</p>
<p>Give it a try.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@widgets</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="nb">slice</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">53</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plot_struct</span><span class="p">(</span><span class="nb">slice</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">structural_data</span><span class="p">[:,:,</span><span class="nb">slice</span><span class="p">],</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6cacea86feb24f43bb70498664d9a65d", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>Alright, that looks like a brain in a skull. For your orientation we are looking at the person’s brain from the top with slice 0 being the lowest one and slice 53 at the top of the head. This is known as an “axial” or “transverse” view of the brain.</p>
<p>If you want to know more about this concept check out the respective Wikipedia page (https://en.wikipedia.org/wiki/Anatomical_plane).</p>
<div class="alert alert-info" role="alert">
  <strong>Question 2</strong> <br>
    Use the slider to move through slices in the structural image. Can you find the eyes? What is the value of the slices where you can see the eye?
</div><div class="alert alert-warning" role="alert">
  <strong>Your Answer</strong> <br>
  Delete this text and put your answer here.
</div><p>Now let’s turn back to the functional data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">functional_data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64, 64, 64, 96)
</pre></div>
</div>
</div>
</div>
<p>If we want to view 2D views of the fuctional data we need to select a plane in which we “cut” or slice the brain like in the structural image, but we also have a fourth dimension of time that is 96 elements long. This means we have a version of our 64x64x64 box at each of 96 timepoints, representing the measured BOLD signal in each voxel at each of 96 timepoints.</p>
<p>So if we want to plot we need to choose one of the spatial dimensions to slice through and also a single timepoint for which we’d like to see that plane.</p>
<p>Here is a version of the slider image we looked at before using the structural data, but now using the coronal data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@widgets</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="nb">slice</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">53</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plot_functional</span><span class="p">(</span><span class="nb">slice</span><span class="p">):</span>
    <span class="n">tp</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">functional_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="nb">slice</span><span class="p">,</span> <span class="n">tp</span><span class="p">],</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ddf120d72af7490880164dfc5186915c", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>Can you find the eyes in this image? How does it look compared to the structural image?</p>
<div class="alert alert-info" role="alert">
  <strong>Question 2</strong> <br>
    Take a look at where we index the functional_data array in the `plot_functional` function. Can you tell which timepoint we are using for plotting these data?
</div><div class="alert alert-warning" role="alert">
  <strong>Your Answer</strong> <br>
  Delete this text and put your answer here.
</div></div>
<div class="section" id="timecourse-of-activation-for-a-single-voxel">
<h2>Timecourse of activation for a single voxel<a class="headerlink" href="#timecourse-of-activation-for-a-single-voxel" title="Permalink to this headline">¶</a></h2>
<p>The images we just created show the BOLD activation value in all the voxels in a slice at a single point in time. But one of the things we’d like to use fMRI data for is to evaluate whether an individual voxel’s signal change over time is related to a cognitive or perceptual task.</p>
<p>So let’s take a single voxel and look at its’ timecourse of activation. To do this we will use the same logic as for plotting a 2d slice, but now we will give a single index for the x, y, and z dimensions, corresponding to a single voxel’s coordinates in 3D space, and then take all the values from the fourth dimension (time) using ‘:’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_coord</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">y_coord</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">z_coord</span> <span class="o">=</span> <span class="mi">35</span>

<span class="c1"># get all of the values over time for a single voxel</span>
<span class="n">one_voxel_timecourse</span> <span class="o">=</span> <span class="n">functional_data</span><span class="p">[</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">,</span> <span class="n">z_coord</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-info" role="alert">
  <strong>Question 3</strong> <br>
    What is the shape of our one_voxel_timecourse variable? What does that number correspond to?
</div><div class="alert alert-warning" role="alert">
  <strong>Your Answer</strong> <br>
  Delete this text and put your answer here.
</div><p>Let’s plot the timecourse of activation for that voxel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an empty plot with defined aspect ratio</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

<span class="n">x_coord</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">y_coord</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">z_coord</span> <span class="o">=</span> <span class="mi">35</span>

<span class="c1"># get all of the values over time for a single voxel</span>
<span class="n">one_voxel_timecourse</span> <span class="o">=</span> <span class="n">functional_data</span><span class="p">[</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">,</span> <span class="n">z_coord</span><span class="p">,</span> <span class="p">:]</span>

<span class="c1"># Plot the timecourse of a random voxel</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">one_voxel_timecourse</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">one_voxel_timecourse</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time [s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;signal strength&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;voxel time course&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/LabReg-MRI-Pt1_42_0.png" src="../_images/LabReg-MRI-Pt1_42_0.png" />
</div>
</div>
<p>Hmm. Looks like data. What if we plot some the signal timecourse from some more voxels?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an empty plot with defined aspect ratio</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

<span class="c1"># voxel indices for one voxel</span>
<span class="n">x_coord</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">y_coord</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">z_coord</span> <span class="o">=</span> <span class="mi">35</span>

<span class="c1"># Plot the timecourse of a random voxel from the transveral array</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">functional_data</span><span class="p">[</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">,</span> <span class="n">z_coord</span><span class="p">,</span> <span class="p">:],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># choose some more voxels at random  and plot 100 more voxel timecourses</span>
<span class="c1"># COMPREHENSION CHECK: why do we choose a random index value between 0 and 64? Why not 0 and 100?</span>
<span class="n">n_voxels_to_plot</span><span class="o">=</span><span class="mi">100</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_voxels_to_plot</span><span class="p">):</span>
    <span class="n">x_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">y_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">z_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">functional_data</span><span class="p">[</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">,</span> <span class="n">z_coord</span><span class="p">,</span> <span class="p">:],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">functional_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time [s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;signal strength&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;voxel time course&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/LabReg-MRI-Pt1_44_0.png" src="../_images/LabReg-MRI-Pt1_44_0.png" />
</div>
</div>
<p>This is the timecourse for 100 voxels in our participants brain. How can we make sense of all this data?</p>
<p>Even with the small number of voxels plotted above we can see that the activation timecourses differ in their average level of signal as well as their dynamics over time. In order to get more insights out of this kind of data we need to put more effort into analyzing the temporal dimension of the data.</p>
</div>
<div class="section" id="voxel-timecourses-and-correlation">
<h2>Voxel timecourses and correlation<a class="headerlink" href="#voxel-timecourses-and-correlation" title="Permalink to this headline">¶</a></h2>
<p>One of the most direct ways to understand fMRI data is to see whether different voxel timecourses correlate with some predictor variable of interest. We will unpack this throughout the rest of this and the next MRI labs, but it should seem familiar: we have already seen examples of computing the correlation between two sets of numbers to understand whether there is a relationship between them.</p>
<p>We also saw that in some ways regression operates in a related way where we’d like to find the closest match between predictor variable (sleep) and the values of some measured outcomes (grumpiness). Later we will explore this idea further by seeing if we can relate the stimuli that a participant was perceiving to the responses in their brain but for now let’s warm up by revisiting correlation and using some of our new knowledge about indexing numpy arrays.</p>
<div class="alert alert-info" role="alert">
  <strong>Question 3</strong> <br>
    Get the full timecourse for two voxels in the functional data (you'll need a different set of x,y,z coordinates for each voxel and all of the values in the time dimension of the functional_data array). Take a look back at the "Timecourse of activation for a single voxel" section above if you need a reminder on how to get the timeseries for one voxel.
<p>Once you have the activation values for each voxel you should (A) plot them on the same plot using the sample code below; (B) compute the correlation coefficient (r value) between the two timeseries.</p>
</div><div class="alert alert-warning" role="alert">
  <strong>Your Answer</strong> <br>
  Delete this text and put your answer here. You can adapt the example plotting code below and add your correlation code.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># example for plotting two timeseries on the same plot</span>

<span class="c1"># Create an empty plot with defined aspect ratio</span>
<span class="c1"># ax is the &#39;handle&#39; for the plot and we use it to tell python where to put the data we&#39;re plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>


<span class="c1"># You&#39;ll need to get the timeseries of activation for two voxels and put them in these two variables:</span>
<span class="n">voxel_1_tc</span> <span class="o">=</span> 
<span class="n">voxel_2_tc</span> <span class="o">=</span> 

<span class="c1"># Plot the timecourse of each voxel to the current axes</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">voxel_1_tc</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;voxel_1_tc&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">voxel_2_tc</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;voxel_2_tc&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">voxel_1_tc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time [s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;signal strength&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;voxel time course&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">  File</span><span class="nn"> &quot;&lt;ipython-input-14-d571667986d3&gt;&quot;</span><span class="gt">, line </span><span class="mi">9</span>
    <span class="n">voxel_1_tc</span> <span class="o">=</span>
                 <span class="o">^</span>
<span class="ne">SyntaxError</span>: invalid syntax
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="relating-brain-data-to-the-experimental-protocol">
<h2>Relating brain data to the experimental protocol<a class="headerlink" href="#relating-brain-data-to-the-experimental-protocol" title="Permalink to this headline">¶</a></h2>
<p>Congratulations! You’re on your way to analyzing fMRI data. In the example above we computed the correlation between time voxel timeseries.</p>
<p>The general approach to analyzing fMRI data builds on this approach but instead of correlating a voxel timeseries with another voxel timeseries (although we will return to this later) we see whether there is a relationship between a predictor variable representing the cognitive or perceptual context over the coures of the experiment and any individual voxels. If the predictor variable composed from the cognitive or perceptual considerations of the experiment can <em><strong>explain</strong></em> the variation in a voxel timeseries we would have some evidence on which to make inferences about what that part of the brain is doing.</p>
<p>The data we have been playing with in this notebook come from an experiment in which the participant alternated between listening to spoken words or hearing nothing.</p>
<p>So let’s think:</p>
<p>How would you imagine the brain signal response to look in a study like this? If a part of the brain was involved in processing spoken verbal stimuli what would we predict its’ activation to look?</p>
<p>For now, lets keep things simple and just assume that without a stimulus (the playing of “bi-syllabic words”) the signal in a sound-sensitive part of the brain is at a baseline level and during the auditory stimulation the signal goes up.</p>
<p>Let’s make a simple “model” of what that would look like.</p>
<p>In order to do it we will need some details about the experiment and MRI scanning. We’ll come back to this later, but for now let’s use them to make a timecourse of what we think it would like for a brain region to be “active” during auditory stimulation and “silent” during rest (no stimulation).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># These are the main parameters of the fMRI scan and experimental design</span>
<span class="n">block_design</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rest&#39;</span><span class="p">,</span> <span class="s1">&#39;stim&#39;</span><span class="p">]</span>
<span class="n">block_size</span>      <span class="o">=</span> <span class="mi">6</span>
<span class="n">block_RT</span>        <span class="o">=</span> <span class="mi">7</span>
<span class="n">block_total</span>     <span class="o">=</span> <span class="mi">16</span>
<span class="n">block_length</span>    <span class="o">=</span> <span class="n">block_size</span><span class="o">*</span><span class="n">block_RT</span>

<span class="n">acq_num</span>         <span class="o">=</span> <span class="n">block_size</span><span class="o">*</span><span class="n">block_total</span>
<span class="n">data_time</span>       <span class="o">=</span> <span class="n">block_length</span><span class="o">*</span><span class="n">block_total</span>
<span class="n">data_time_vol</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">acq_num</span><span class="p">)</span><span class="o">*</span><span class="n">block_RT</span>

<span class="n">x_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">y_size</span> <span class="o">=</span> <span class="mi">64</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we can use the experimental parameters to make timecourse plot showing when the auditory stimulation happened</span>
<span class="n">rest</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">block_size</span><span class="p">)</span>
<span class="n">stim</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">block_size</span><span class="p">)</span>
<span class="n">block</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rest</span><span class="p">,</span> <span class="n">stim</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">predicted_response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">block_total</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">predicted_response</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">acq_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;predicted response&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time [volumes]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># fig.subplots_adjust(wspace=0, hspace=0.5)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/LabReg-MRI-Pt1_52_0.png" src="../_images/LabReg-MRI-Pt1_52_0.png" />
</div>
</div>
<p>Let’s take a moment to look at this plot. This represents the timecourse of auditory stimulation in the our experiment. The x-axis represents time and the y-axis shows whether sound was on (<span class="math notranslate nohighlight">\(y=1\)</span>) or off (<span class="math notranslate nohighlight">\(y=0\)</span>).</p>
<p>This is the set of values, one for each point in time that we will use to try to understand the fMRI data collected in this experiment. We will search through the brain, looking to see whether any voxel timeseries are well explained by this predicted response and if they are we might conclude that they are involved in hearing.</p>
<p>Before we conduct a full brain regression let’s try a correlation approach.</p>
<p>We will use np.corrcoef() to compute the correlation between between the predicted response and all the voxel timeseries.</p>
<p>Actually we won’t do it for all the voxel timeseries because there are alot of them and it will either take a long time or crash our computer.</p>
<div class="alert alert-info" role="alert">
  <strong>Question 4</strong> <br>
    How many total voxels are in our functional dataset? In other words, how many elements are there in the 3D grid contained in the functional data array?
</div><div class="alert alert-warning" role="alert">
  <strong>Your Answer</strong> <br>
  Delete this text and put your answer here.
</div><p>Yeah.. that’s too many voxels to run all at once right now.</p>
<p>Let’s take a slice of our data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_slice_data</span> <span class="o">=</span> <span class="n">functional_data</span><span class="p">[:,:,</span><span class="mi">36</span><span class="p">,:]</span>
<span class="n">one_slice_data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64, 64, 96)
</pre></div>
</div>
</div>
</div>
<p>Now we need to turn this 3D array (x,y, and t) into a 2D array to use in np.corrcoef. We can use the numpy reshape function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_slice_voxels</span> <span class="o">=</span> <span class="n">one_slice_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">one_slice_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">one_slice_data_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">one_slice_data</span><span class="p">,</span> <span class="p">(</span><span class="n">n_slice_voxels</span><span class="p">,</span> <span class="n">one_slice_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">one_slice_data_2d</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(4096, 96)
</pre></div>
</div>
</div>
</div>
<p>OK great, now we have voxels by time. Let’s see if any of the voxel timeseries correlates with our predicted response</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#### np.corrcoef does not return the p value so we will use scipy.stats.pearsonr instead</span>

<span class="c1"># c = np.corrcoef(predicted_response, one_slice_data_2d)[1:,0]</span>
<span class="c1"># c.shape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the correlation betweeen each voxel timeseries and the predicted response</span>
<span class="c1"># store the pearsons r value in r_values and the corresponding significance level in p_values</span>

<span class="n">r_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">p_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># loop over every timeseries in one_slice_data_2d</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">one_slice_data_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">r</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">predicted_response</span><span class="p">,</span> <span class="n">one_slice_data_2d</span><span class="p">[</span><span class="n">idx</span><span class="p">,:])</span>
<span class="c1">#     r_values.append(stats.pearsonr(predicted_response, one_slice_data_2d[idx,:])[1])</span>
<span class="c1">#     c_2.append(stats.pearsonr(predicted_response, one_slice_data_2d[idx,:])[1])</span>
    <span class="n">r_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<p>Now we have 4096 correlation values, one for each voxel in our slice, telling us how much that voxel timeseries correlated with the predictor timeseries. Let’s reshape that so we can plot the correlation values as an image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we&#39;ll use some numpy convenience functions to find the indices of the voxel with the highest correlation value</span>

<span class="c1"># make a 2d representation of the correlation values</span>
<span class="n">r_values_as_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="p">(</span><span class="n">one_slice_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">one_slice_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">p_values_as_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">p_values</span><span class="p">,</span> <span class="p">(</span><span class="n">one_slice_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">one_slice_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># get the x,y indices of the max correlation value</span>
<span class="n">max_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">r_values_as_slice</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">r_values_as_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look and see how the timecourse from the most correlated voxel looks compared to the predictor timecourse:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use the max_xy values to get the voxel timecourse that has the highest correlation</span>
<span class="c1"># max_xy is the x and y coordinate of the voxel whose activation is most correlated with the predictor timecourse</span>
<span class="n">max_corr_timecourse</span> <span class="o">=</span> <span class="n">one_slice_data</span><span class="p">[</span><span class="n">max_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]</span>

<span class="c1"># the raw timecourse is on a different scale that the predictor response so we will scale the values so </span>
<span class="c1"># they are all between zero and one</span>

<span class="c1"># Define the min-max scaling function</span>
<span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>


<span class="c1"># Create the plots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">max_corr_timecourse</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;scaled voxel tc&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">predicted_response</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;predictor tc&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">acq_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time [volumes]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/LabReg-MRI-Pt1_67_0.png" src="../_images/LabReg-MRI-Pt1_67_0.png" />
</div>
</div>
<p>Hey that looks pretty good!</p>
<p>OK now we can see that the timecourse for this voxel looks similar to our assumed response if a voxel was to respond to sound like in the predicted timecourse.</p>
<p>But how are voxels that correlate with our idealized timecourse distributed across the brain? Lets check.<br></p>
<p>We will make a figure that has three panels:</p>
<p>One will show the image of the brain like before, the next will show an image where each voxel is colored according to the pearsons <span class="math notranslate nohighlight">\(r\)</span> value calculated in the correlation above, and the third image will show a “thresholded” map of the correlation values, showing only those voxels whose correlation value is above a desired threshold.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use some numpy magic to get an array that is nan everywhere that the correlation value is less than .2</span>

<span class="c1"># first make a copy of the correlation values</span>
<span class="n">r_thresholded</span> <span class="o">=</span> <span class="n">r_values_as_slice</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># now set any values less than .2 to be equal to nan</span>
<span class="n">r_thresh</span> <span class="o">=</span> <span class="mf">.2</span>
<span class="n">r_thresholded</span><span class="p">[</span><span class="n">r_thresholded</span> <span class="o">&lt;</span> <span class="n">r_thresh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ok now lets visualize all the maps</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Create the plots</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">functional_data</span><span class="p">[:,:,</span><span class="mi">36</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;brain slice&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>


<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">r_values_as_slice</span><span class="p">,</span>  <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;afmhot&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;un-thresholded map&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>


<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">functional_data</span><span class="p">[:,:,</span><span class="mi">36</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">r_thresholded</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;afmhot&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;thresholded map (r &gt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r_thresh</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
<img alt="../_images/LabReg-MRI-Pt1_71_1.png" src="../_images/LabReg-MRI-Pt1_71_1.png" />
</div>
</div>
<p>Look at that, we made some brain maps!</p>
<p>And it looks like there is some structure to the data.</p>
<p>The data we’re looking at is oriented so that the front of the participant head is pointing up and the left/right of their head is in the left/right of the figure.</p>
<p>The un-thresholded map in the middle is showing correlation value for each voxel.</p>
<p>The thresholded map is made by finding the voxels in the untresholded map whose correlation values are above our threshold of 0.2 and overlaying them on the brain slice image. The color of the voxels indicates the strength of the correlation (the <span class="math notranslate nohighlight">\(r\)</span> value) with higher <span class="math notranslate nohighlight">\(r\)</span> values in brighter colors.</p>
<p>The analysis we did was to measure whether any voxels correlated with our the predicted response (the timeseries of auditory activation) and it seems like the voxels with the highest values are on the side of the head, possibly near the ears. Very cool!</p>
<p>But you also might notice that there are other voxels that are colored here. This is the issue we will return to in the next lab when we learn about dealing with multiple comparisons and false positives when you have lots of data.</p>
<p>As a final exercise this week, let’s play with the significance threshold for plotting brain maps.</p>
<p>This next cell will define a convenience function to wrap up the thresholded plotting code we used to make the figure above, except we will switch and adjust the <em><strong>p</strong></em> value associated with the calculated correlation coeffecients (<span class="math notranslate nohighlight">\(r\)</span>).</p>
<p>The <em><strong>p</strong></em> value corresponds to the “signifiance” of a single correlation test and represents the chances of observing an <span class="math notranslate nohighlight">\(r\)</span> value that high by chance. This is the value that we use for the classic <span class="math notranslate nohighlight">\(p &lt; 0.05\)</span> threshold for deciding whether a statistical result is significant.</p>
<p>In the next cell we can use the slider to change the p value threshold, and only those voxels whose correlation had a p value <em><strong>less than</strong></em> the slide value will be plotted.</p>
<p>The voxels will be colored according to their p value, with more significant voxels (lower p values) plotted in brighter colors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@widgets</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">p_threshold</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">.0000000000001</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">.00001</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">40</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plot_thresholded_brains</span><span class="p">(</span><span class="n">p_threshold</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">p_threshold</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_threshold</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span><span class="s1">&#39;p_reshold should be between 0 and 1&#39;</span>
    <span class="c1"># first make a copy of the correlation values</span>
    <span class="n">p_thresh</span> <span class="o">=</span> <span class="n">p_values_as_slice</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># now set any voxels with p greater than p_threshold to be equal to nan</span>
    <span class="n">p_thresh</span><span class="p">[</span><span class="n">p_thresh</span> <span class="o">&gt;</span> <span class="n">p_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">functional_data</span><span class="p">[:,:,</span><span class="mi">36</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">p_thresh</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;afmhot_r&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;thresholded map (p &lt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_threshold</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9ea39ac15c99432e9d0702175e5b53b4", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<div class="alert alert-info" role="alert">
  <strong>Question 5</strong> <br>
    Play with the slider, trying out different significance thresholds. What happens if you make the threshold very lenient? What happens if you make it very strict? Pay particular attention to the spatial distribution of the voxels in the thresholded map. What do you notice about the spatial arrangement of the voxels who have the most significant correlation with the predictor timecourse? Where are those voxels compared to each other? What about the voxels that are significant at p < .29? Do you notice anything funny about where some of these voxels are relative to the underlying gray brain image?
</div><div class="alert alert-warning" role="alert">
  <strong>Your Answer</strong> <br>
  Delete this text and put your answer here.
</div></div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./labs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Todd Gureckis<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>