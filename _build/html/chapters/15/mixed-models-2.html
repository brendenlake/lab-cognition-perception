
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mixed models &#8212; Lab in C&amp;P (Fall 2021)</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nyustyle.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      <img src="../../_static/artificialintelligence.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Lab in C&P (Fall 2021)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Overview
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../course-content/syllabus.html">
   Syllabus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../course-content/schedule.html">
   Schedule
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Resources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://edstem.org/us/courses/8295/discussion/">
   EdStem
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Textbook
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../00/00-cogsci.html">
   1. What is Cognitive Science and how do we study it?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../01/00-whystats.html">
   2. Why do we have to learn statistics?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02/00-jupyter.html">
   3. Introduction to Jupyter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../03/00-python.html">
   4. Intro to Python for Psychology Undergrads
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../04/00-researchdesign.html">
   5. A brief introduction to research design
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../05/00-data.html">
   6. The Format and Structure of Digital Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../06/00-plots.html">
   7. Visualizing Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../07/00-describingdata.html">
   8. Describing Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../08/01-sampling.html">
   9. Samples, populations and sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../09/00-hypothesistesting.html">
   10. Hypothesis testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../10/00-ttest.html">
   11. Comparing one or two means
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../11/00-inferences-from-behavior.html">
   12. Measuring Behavior
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../21/00-ethics-irb.html">
   13. Research Ethics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../13/00-linearregression.html">
   14. Linear regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../14/00-logisticregression.html">
   15. Logistic regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="00-mixed-effect.html">
   16. Linear Mixed Effect Modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../16/00-mentalsimulation.html">
   17. Mental Imagery, Mental Simulation, and Mental Rotation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../17/00-mri.html">
   18. Magnetic Resonance Imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../24/00-what-next.html">
   19. What Next?
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Labs &amp; Homeworks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../00/cogsci-ica.html">
   Intro to CogSci ICA
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../homeworks/Homework1.html">
   Intro to Jupyter (HW1)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tips &amp; Tricks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../tips/pythonresources.html">
   Python Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tips/plottingresources.html">
   Plotting in Python Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tips/fortyforloops.html">
   Intro to For loops
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tips/nyu-jupyterhub.html">
   NYU JupyterHub Setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tips/ultimate-guide-ttest-python.html">
   Ultimate t-test guide
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  About
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../LICENSE.html">
   License
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/chapters/15/mixed-models-2.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        
        <a class="jupyterhub-button" href="https://psychua-46-fall.rcnyu.org//hub/user-redirect/git-pull?repo=https://github.com/executablebooks/jupyter-book&urlpath=tree/jupyter-book/chapters/15/mixed-models-2.ipynb&branch=master"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="../../_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#acknowledgements">
   Acknowledgements:
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataset">
   Dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interacting-with-the-data">
   1. Interacting with the data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#linear-regression">
   2. Linear Regression
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simple-linear-regression">
     Simple Linear Regression
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-separate-linear-regression">
   3a. Separate Linear Regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-modelling-county-as-a-fixed-effect">
   3b. Modelling county as a fixed effect
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mixed-effects-models">
   4. Mixed effects models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fixed-vs-random">
     Fixed vs random?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fitting-our-mixed-effect-lm">
     Fitting our mixed effect lm
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#wrap-up">
   5. Wrap Up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#take-home-challenges">
   Take home challenges
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-the-initial-linear-regression-was-significant">
     1. Test the initial linear regression was significant
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-the-rmse-for-the-individual-linear-regressions">
     2. Calculate the RMSE for the individual linear regressions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-in-locations-for-the-mixed-effect-model">
     3. Add in locations for the mixed effect model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#glm-mixed-effect-for-logistic">
     4. glm mixed effect for logistic
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-on-the-strengths-of-a-mutlievel-mixed-effects-modelling-vs-random-forests">
     5. Read on the strengths of a mutlievel (mixed-effects) modelling vs random forests.
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-performance-to-random-forest">
     6. Compare performance to random forest
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="mixed-models">
<h1>Mixed models<a class="headerlink" href="#mixed-models" title="Permalink to this headline">¶</a></h1>
<div class="section" id="acknowledgements">
<h2>Acknowledgements:<a class="headerlink" href="#acknowledgements" title="Permalink to this headline">¶</a></h2>
<p>Firstly, it’s right to pay thanks to the blogs and sources I have used in writing this tutorial. A similar tutoral in R formed much of the framework by <a class="reference external" href="https://twitter.com/AmidstScience">Gabriela K Hajduk</a>, <a class="reference external" href="https://twitter.com/ldbailey255">Liam Bailey</a> and the brilliant https://ourcodingclub.github.io/ - if you are an R developer check it out. Also big thanks to Junpeng Lao (https://github.com/junpenglao) for detailing the many different ways you can implement mixed-effect models in python (as there is always more than one), so look in the extension material in the end for links to one of his notebooks.</p>
</div>
<div class="section" id="dataset">
<h2>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline">¶</a></h2>
<p>Today we will be using a dataset that looks at the bounce rates of users of a website with cooking recipes. A bounce rate is a measure of how quickly someone leaves a website, e.g. the number of seconds after which a user first accesses a webpage from the website and then leaves. Most websites want individuals to stay on their websites for a long time as they are more likely to read another article, buy one of their products, click on some of the sponsored links etc. As such, it can be useful to understand why some users leave the website quicker than others.</p>
<p>To investigate the bounce rate of the website, we chose three locations in 8 counties in England, and got members of the public of all ages to undertake a survey/test questionaire. In the test we asked them to use our search engine to query for something they want to eat this evening. The search engine listed our website first, as well as other websites that would be returned. The users that clicked on our website were then timed and their bounce time recorded. We also recorded their age, and made a note of the county and location.</p>
<p>We have been asked by the website to work out if younger individuals are more likely to leave the website quicker.</p>
</div>
<div class="section" id="interacting-with-the-data">
<h2>1. Interacting with the data<a class="headerlink" href="#interacting-with-the-data" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import modules needed</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span><span class="p">;</span> <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sklearn</span> <span class="k">as</span> <span class="nn">sk</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read in our data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../input/data.csv&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>bounce_time</th>
      <th>age</th>
      <th>county</th>
      <th>location</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>165.548520</td>
      <td>16</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>1</th>
      <td>167.559314</td>
      <td>34</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>2</th>
      <td>165.882952</td>
      <td>6</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>3</th>
      <td>167.685525</td>
      <td>19</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>4</th>
      <td>169.959681</td>
      <td>34</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>5</th>
      <td>168.688747</td>
      <td>47</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>6</th>
      <td>169.619382</td>
      <td>7</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>7</th>
      <td>164.416273</td>
      <td>8</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>8</th>
      <td>167.510430</td>
      <td>8</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>9</th>
      <td>179.606068</td>
      <td>7</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>10</th>
      <td>174.465485</td>
      <td>40</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>11</th>
      <td>164.781248</td>
      <td>38</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>12</th>
      <td>172.559467</td>
      <td>23</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>13</th>
      <td>179.000774</td>
      <td>7</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>14</th>
      <td>175.970409</td>
      <td>18</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>15</th>
      <td>170.819319</td>
      <td>16</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>16</th>
      <td>170.053440</td>
      <td>20</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>17</th>
      <td>171.093272</td>
      <td>20</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>18</th>
      <td>166.957118</td>
      <td>27</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>19</th>
      <td>169.770832</td>
      <td>18</td>
      <td>devon</td>
      <td>a</td>
    </tr>
    <tr>
      <th>20</th>
      <td>177.174444</td>
      <td>46</td>
      <td>devon</td>
      <td>b</td>
    </tr>
    <tr>
      <th>21</th>
      <td>170.686850</td>
      <td>20</td>
      <td>devon</td>
      <td>b</td>
    </tr>
    <tr>
      <th>22</th>
      <td>176.740267</td>
      <td>18</td>
      <td>devon</td>
      <td>b</td>
    </tr>
    <tr>
      <th>23</th>
      <td>182.921515</td>
      <td>20</td>
      <td>devon</td>
      <td>b</td>
    </tr>
    <tr>
      <th>24</th>
      <td>182.353952</td>
      <td>25</td>
      <td>devon</td>
      <td>b</td>
    </tr>
    <tr>
      <th>25</th>
      <td>183.081931</td>
      <td>12</td>
      <td>devon</td>
      <td>b</td>
    </tr>
    <tr>
      <th>26</th>
      <td>182.175331</td>
      <td>30</td>
      <td>devon</td>
      <td>b</td>
    </tr>
    <tr>
      <th>27</th>
      <td>175.512214</td>
      <td>4</td>
      <td>devon</td>
      <td>b</td>
    </tr>
    <tr>
      <th>28</th>
      <td>173.532395</td>
      <td>27</td>
      <td>devon</td>
      <td>b</td>
    </tr>
    <tr>
      <th>29</th>
      <td>174.221700</td>
      <td>5</td>
      <td>devon</td>
      <td>b</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the distribution of the bounce times - this creates the object that will be plotted when matplotlib.pyplot</span>
<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">bounce_time</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_6_0.png" src="../../_images/mixed-models-2_6_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the distribution of the ages</span>
<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_7_0.png" src="../../_images/mixed-models-2_7_0.png" />
</div>
</div>
<p>Before we carry on it is often a good idea to <strong>scale</strong> our independent (explanatory) variables so that they are <strong>standardised</strong>. This is useful as it means that any estimated coefficient from our regression model later on are all on the same scale. So, for our dataset this would be the age, and let’s create a new variable called <strong>age_scaled</strong>, which is the age scaled to have zero mean and unit variance:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lets use the scale function from the preprocess package within sklearn</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;age_scaled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This scaling won’t impact the statistical findings in our example but you may find in more complex models than the one in this tutorial this can be very helpful in speeding up your models fitting. It is also makes comparison between a continous variable like age, and a binary variable (0, 1) more fair. Thanks to a couple of the s2ds people from last night for asking about this!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the distribution</span>
<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">age_scaled</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_11_0.png" src="../../_images/mixed-models-2_11_0.png" />
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="linear-regression">
<h2>2. Linear Regression<a class="headerlink" href="#linear-regression" title="Permalink to this headline">¶</a></h2>
<p>The first thing we might want to do to see if the bounce time is dependent on the age is to plot this data, and then fit a linear regression to the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s use the lmplot function within seaborn</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;bounce_time&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x7f0c766010b8&gt;
</pre></div>
</div>
<img alt="../../_images/mixed-models-2_14_1.png" src="../../_images/mixed-models-2_14_1.png" />
</div>
</div>
<p>It would seem, from this simple analysis that older people do spend longer time on the website. To go into this further let’s look at what the coefficients estimated are within our linear model. We looked at similar things n a previous meetup on generalised linear models and at lasso and ridge regression (https://www.meetup.com/central_london_data_science/events/249149833/), so without repeating too much of the material from that meetup (github here - https://github.com/central-ldn-data-sci/regression2000), here is a quick overview again of what a linear regression model is</p>
<div class="section" id="simple-linear-regression">
<h3>Simple Linear Regression<a class="headerlink" href="#simple-linear-regression" title="Permalink to this headline">¶</a></h3>
<p>We will start with the most familiar linear regression, a straight-line fit to data.
A straight-line fit is a model of the form</p>
<div class="math notranslate nohighlight">
\[
y = b_0 + b_1x 
\]</div>
<p>where <span class="math notranslate nohighlight">\(b_1\)</span> is commonly known as the <em>gradient</em>, and <span class="math notranslate nohighlight">\(b_0\)</span> is commonly known as the <em>intercept</em>. So for our dataset, <code class="docutils literal notranslate"><span class="pre">y</span></code> would be the bounce time, <code class="docutils literal notranslate"><span class="pre">x</span></code> their age, <code class="docutils literal notranslate"><span class="pre">b_1</span></code> the rate of change of the bounce time with respect to <code class="docutils literal notranslate"><span class="pre">age</span></code> and <code class="docutils literal notranslate"><span class="pre">b_0</span></code> the intercept when <code class="docutils literal notranslate"><span class="pre">age</span></code> is 0.</p>
<div class="math notranslate nohighlight">
\[
time = b_0 + b_1age
\]</div>
<p>We can use Scikit-Learn’s <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> estimator to fit this data and construct the best-fit line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="c1"># construct our linear regression model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">age_scaled</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bounce_time</span>

<span class="c1"># fit our model to the data</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># and let&#39;s plot what this relationship looks like </span>
<span class="n">xfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">yfit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xfit</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xfit</span><span class="p">,</span> <span class="n">yfit</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_18_0.png" src="../../_images/mixed-models-2_18_0.png" />
</div>
</div>
<p>We can have a look at these parameters within the model object, with the relevant parameters being <code class="docutils literal notranslate"><span class="pre">coef_</span></code> and <code class="docutils literal notranslate"><span class="pre">intercept_</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model slope:    &quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model intercept:&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model slope:     6.279602007970821
Model intercept: 201.31646151854164
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and let&#39;s store the rmse</span>
<span class="n">y_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">RMSE</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">y</span><span class="o">-</span><span class="n">y_predict</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">results</span><span class="p">[</span><span class="s2">&quot;Method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Linear Regression&quot;</span><span class="p">]</span>
<span class="n">results</span><span class="p">[</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RMSE</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Method</th>
      <th>RMSE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Linear Regression</td>
      <td>14.928334</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>So from this we would say quite confidently that as age increases so does the bounce time. (To test if this increase is significant see the take home challenge 1.)</p>
<p>However, to run a linear regression a number of assumptions about the data need to be met. One of these is that the residuals are <strong>homoscedastic</strong>, which means that the residuals are normally distributed in relation to the predicted value, i.e. are our predictions equally bad (or good) across our predicted values. We can look at this by plotting the residuals, using my new favourite package yellowbrick:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!conda install -c districtdatalabs yellowbrick</span>
<span class="kn">import</span> <span class="nn">yellowbrick</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">yellowbrick.regressor</span> <span class="kn">import</span> <span class="n">ResidualsPlot</span>

<span class="c1"># Instantiate the linear model and visualizer</span>
<span class="n">visualizer</span> <span class="o">=</span> <span class="n">ResidualsPlot</span><span class="p">(</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">)</span>

<span class="n">visualizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># Fit the training data to the model</span>
<span class="n">visualizer</span><span class="o">.</span><span class="n">poof</span><span class="p">()</span>                    <span class="c1"># Draw/show/poof the data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_23_0.png" src="../../_images/mixed-models-2_23_0.png" />
</div>
</div>
<p>Actually not toooooo bad - you could say that there are more positive residuals than negative residuals at the highest and lowest predicted value ranges, e.g. predicted value &lt; 195, and &gt;210 there are more positive residuals than negative. You can have a look at this also using seaborn’s <code class="docutils literal notranslate"><span class="pre">residplot</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">residplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;age_scaled&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span> <span class="s2">&quot;bounce_time&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">lowess</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Observed - Prediction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_25_0.png" src="../../_images/mixed-models-2_25_0.png" />
</div>
</div>
<p>Okay, so perhaps its not ideal…</p>
<p>Let’s check some of the other assumptions. For a good list of the assumptions (with code in R), have a look here http://r-statistics.co/Assumptions-of-Linear-Regression.html.</p>
<p>One of the other key assumption is that the observations of our data are independent of the other data. When we collected our data we were doing it in 8 different counties and in 3 locations within each county. So we could check this by comparing the bounce times for each county. To do this let’s use one of the categorical plots in seaborn:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">catplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;bounce_time&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;swarm&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x7f0c62797ba8&gt;
</pre></div>
</div>
<img alt="../../_images/mixed-models-2_27_1.png" src="../../_images/mixed-models-2_27_1.png" />
</div>
</div>
<p>Ah… clearly there is substantial grouping - us Londoners seem to have short attention spans (maybe…). So we can definitely say that our data is not independent, and thus it is inappropriate to use a linear model for this data.</p>
<p>What next? Well maybe we could do a separate regression for each county.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="a-separate-linear-regression">
<h2>3a. Separate Linear Regression<a class="headerlink" href="#a-separate-linear-regression" title="Permalink to this headline">¶</a></h2>
<p>Same as before, we are going to fit a linear regression to the data, but first separating it by county. Mathematically, this now looks like:</p>
<div class="math notranslate nohighlight">
\[
time_c = b_{c0} + b_{c1}age
\]</div>
<p>where the subscript <em>c</em> here represents the county. As a result we will be estimating 8 different intercept and 8 different gradients, one for each county. Let’s have a look at that using the facet grid options within <code class="docutils literal notranslate"><span class="pre">sns.lmplot</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s use the lmplot function within seaborn</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;age_scaled&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;bounce_time&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col_wrap</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_31_0.png" src="../../_images/mixed-models-2_31_0.png" />
</div>
</div>
<p>So now we have 8 different analyses. This is fine, but we have started to reduce our sample size a lot already as a result, and we are now perhaps going too far in the other direction from before. Before we were saying that all counties were identical, whereas here we are saying that the impact of <code class="docutils literal notranslate"><span class="pre">age</span></code> on <code class="docutils literal notranslate"><span class="pre">bounce_time</span></code> share no similarities between counties, which is probably again not true.</p>
<p>In addition, what about our location variable, maybe our data is also not independent when looking at location. Let’s have a look at this too, using a swarm plot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">catplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;bounce_time&quot;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;swarm&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x7f0c6229cc50&gt;
</pre></div>
</div>
<img alt="../../_images/mixed-models-2_33_1.png" src="../../_images/mixed-models-2_33_1.png" />
</div>
</div>
<p>So we could carry on and then do an individual regression for each location within each county… hopefully you can see why we can’t always just do an individual regression for each new group. If we did we would have to to estimate a slope and intercept parameter for each regression. That’s two parameters, three locations and eight counties, which means 48 parameter estimates (2 x 3 x 8 = 48).</p>
<p>Also we would now be taking our nice dataset of 480 observations, that presumably took a long time to collect, and effectively reducing it to lots of sample sizes of 20. This really decreases our statistical power, and thus also increases our chances of a Type I Error (where you falsely reject the null hypothesis) by carrying out multiple comparisons.</p>
<p>So what could we do? Well we could modify the model to account for the different counties, and add it to our linear model.</p>
</div>
<hr class="docutils" />
<div class="section" id="b-modelling-county-as-a-fixed-effect">
<h2>3b. Modelling county as a fixed effect<a class="headerlink" href="#b-modelling-county-as-a-fixed-effect" title="Permalink to this headline">¶</a></h2>
<p>One way to incorporate the impact of county is to bring the county in to our equation for the linear model by treating it as a fixed effect. This would look like:</p>
<div class="math notranslate nohighlight">
\[
time_{c_{i}} = b_{0} + b_{1}age + c_i
\]</div>
<p>i.e. each county has it’s own additional term that wil change the intercept. To model this we will need to alter our dataframe to encode our counties as numeric variables. So we will use <strong>one-hot encoding</strong>, where we will make a new column for each county:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make a new data frame with one hot encoded columns for the counties</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">county</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">data_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">county</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data_new</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>bounce_time</th>
      <th>age</th>
      <th>county</th>
      <th>location</th>
      <th>age_scaled</th>
      <th>cheshire</th>
      <th>cumbria</th>
      <th>devon</th>
      <th>dorset</th>
      <th>essex</th>
      <th>kent</th>
      <th>london</th>
      <th>norfolk</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>165.548520</td>
      <td>16</td>
      <td>devon</td>
      <td>a</td>
      <td>-1.512654</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>167.559314</td>
      <td>34</td>
      <td>devon</td>
      <td>a</td>
      <td>-0.722871</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>165.882952</td>
      <td>6</td>
      <td>devon</td>
      <td>a</td>
      <td>-1.951423</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>167.685525</td>
      <td>19</td>
      <td>devon</td>
      <td>a</td>
      <td>-1.381024</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>169.959681</td>
      <td>34</td>
      <td>devon</td>
      <td>a</td>
      <td>-0.722871</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct our linear regression model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data_new</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="s2">&quot;age_scaled&quot;</span><span class="p">],</span><span class="n">counties</span><span class="p">))]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bounce_time</span>

<span class="c1"># fit our model to the data</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># and let&#39;s plot what this relationship looks like </span>
<span class="n">visualizer</span> <span class="o">=</span> <span class="n">ResidualsPlot</span><span class="p">(</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">)</span>
<span class="n">visualizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># Fit the training data to the model</span>
<span class="n">visualizer</span><span class="o">.</span><span class="n">poof</span><span class="p">()</span>     
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_37_0.png" src="../../_images/mixed-models-2_37_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and let&#39;s plot the predictions</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">performance</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">bounce_time</span>
<span class="n">performance</span><span class="p">[</span><span class="s2">&quot;age_scaled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">age_scaled</span>
<span class="n">performance</span><span class="p">[</span><span class="s2">&quot;predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">residplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;age_scaled&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;residuals&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">performance</span><span class="p">,</span> <span class="n">lowess</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Observed - Prediction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_38_0.png" src="../../_images/mixed-models-2_38_0.png" />
</div>
</div>
<p>The residuals are much better than before, being more evenly distributed with respect to age, and if we look at the predictions with each county:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_new</span><span class="p">[</span><span class="s2">&quot;y_predict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;age_scaled&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;y_predict&quot;</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col_wrap</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data_new</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x7f0c5bb69978&gt;
</pre></div>
</div>
<img alt="../../_images/mixed-models-2_40_1.png" src="../../_images/mixed-models-2_40_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and let&#39;s store the rmse</span>
<span class="n">y_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">RMSE</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">y</span><span class="o">-</span><span class="n">y_predict</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Fixed&quot;</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">]</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Method</th>
      <th>RMSE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Linear Regression</td>
      <td>14.928334</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Fixed</td>
      <td>8.563396</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we can se that the coefficient for the gradient given to age is substnantially smaller, and is likely no longer significant. Let’s just check that by making a table of the coefficients:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># coefficient for age and the counties</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="s2">&quot;age_scaled&quot;</span><span class="p">],</span><span class="n">counties</span><span class="p">)),</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>age_scaled</td>
      <td>0.048782</td>
    </tr>
    <tr>
      <th>1</th>
      <td>devon</td>
      <td>-21.381957</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cumbria</td>
      <td>9.391460</td>
    </tr>
    <tr>
      <th>3</th>
      <td>norfolk</td>
      <td>9.824419</td>
    </tr>
    <tr>
      <th>4</th>
      <td>kent</td>
      <td>7.938668</td>
    </tr>
    <tr>
      <th>5</th>
      <td>dorset</td>
      <td>-2.079637</td>
    </tr>
    <tr>
      <th>6</th>
      <td>london</td>
      <td>-21.437323</td>
    </tr>
    <tr>
      <th>7</th>
      <td>cheshire</td>
      <td>18.372916</td>
    </tr>
    <tr>
      <th>8</th>
      <td>essex</td>
      <td>-0.628546</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>But what model have we actually fitted here? Is it what we wanted to investigate initially? The  model is estimating the difference in bounce times between the counties now as well, and we aren’t actually interested in that. If you were then this is correct to do so, but the website company just wanted to know whether age affects the bounce times. And by including county in we are obscuring this. So to look at the impact of age on bounce times we need to control for the variation between the different counties (as well as between the locations). So to do that, we have to treat our counties as <strong>random effects</strong>, and build a <strong>mixed effect model</strong>!</p>
<p>Hurray for getting here!</p>
<p><img alt="" src="https://memegenerator.net/img/instances/57364565/hurray-time-to-close-your-laptops.jpg" /></p>
<p>.. just kidding …</p>
<p>but you have now covered loads of material and can now have a go at using a mixed effect model.</p>
</div>
<hr class="docutils" />
<div class="section" id="mixed-effects-models">
<h2>4. Mixed effects models<a class="headerlink" href="#mixed-effects-models" title="Permalink to this headline">¶</a></h2>
<p>As we have discussed above, a mixed effects model is ideal here as it will allow us to both use all the data we have (higher sample size) and better acknowledge the correlations between data coming from the counties and locations. We will also estimate fewer parameters and avoid problems with multiple comparisons that we would encounter while using separate regressions.</p>
<p>So in this model we treat our <code class="docutils literal notranslate"><span class="pre">age</span></code>, which is what we are interested in, as a <strong>fixed effect</strong>, and <code class="docutils literal notranslate"><span class="pre">county</span></code> and <code class="docutils literal notranslate"><span class="pre">location</span></code> as a <strong>random effect</strong>.</p>
<p>But what does that mean? Well it’s sort of a middle ground here between assuming our coefficient for the gradient and intercept are all the same (what we did in the first regression) and assuming they are all independent and different. If we look back at our equations, we now may assume that while <span class="math notranslate nohighlight">\(b_0\)</span> and <span class="math notranslate nohighlight">\(b_1\)</span> are different for each county, the coefficients all come from a common group distribution, such as a normal distribution:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
time_c = b_{c0} + b_{c1}.age  \\ \\
b_{c0} \sim N(\mu_{b_0}, \sigma^2_{b_0}) \\
b_{c1} \sim N(\mu_{b_1}, \sigma^2_{b_1})
\end{align*}
\end{split}\]</div>
<p>So we now assume the intercepts <span class="math notranslate nohighlight">\(b_0\)</span> and gradients <span class="math notranslate nohighlight">\(b_1\)</span>  come from a normal distribution centered around their respective group mean <span class="math notranslate nohighlight">\(\mu\)</span> with a certain standard deviation <span class="math notranslate nohighlight">\(\sigma^2\)</span>, the values of which we also estimate.</p>
<div class="section" id="fixed-vs-random">
<h3>Fixed vs random?<a class="headerlink" href="#fixed-vs-random" title="Permalink to this headline">¶</a></h3>
<p>So what makes a variable a fixed or random effect. Hmmm, it’s tricky and there are lots of answers out there. In brief, we view fixed effects as the variables that we are interested in. We wanted to know about age so we recorded data on that and wanted to see how it impacted the response variable. County was not we were interested in, but we recorded it as we were aware that our sampling methodology could lead to clustering in our data that could invalidate the linear model from before. If we hadn’t recorded that someone who was given this dataset to analyse may have incorrectly said that  age was an important predictor of bounce rate.</p>
<p>Random effects are often our groups we are trying to control for, like county in our example. In particualr twe control for counties when we have not exhausted all the available groups - we only had 8 counties in England. If we wanted to make predicitons about the counties, then we would have tried to sample them better firstly, and also treat them as a fixed effect.</p>
<p>Further reading for those who want a better answer!:</p>
<p>https://dynamicecology.wordpress.com/2015/11/04/is-it-a-fixed-or-random-effect/</p>
<p>And see the discussion in the paper linked in the take home challenge 3.</p>
</div>
<div class="section" id="fitting-our-mixed-effect-lm">
<h3>Fitting our mixed effect lm<a class="headerlink" href="#fitting-our-mixed-effect-lm" title="Permalink to this headline">¶</a></h3>
<p>We will now fit our model using the <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> library. In this initial model we will look at how the bounce time relates to the scaled ages, while controlling for the impact of counties by allowing for a random intercept for each country, i.e. we are saying that each county has its own random intercept but that the slopes are still the same with respect to age.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!conda install -c conda-forge statsmodels -y</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="c1"># construct our model, with our county now shown as a group</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">mixedlm</span><span class="p">(</span><span class="s2">&quot;bounce_time ~ age_scaled&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">])</span>
<span class="n">mdf</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>          Mixed Linear Model Regression Results
=========================================================
Model:            MixedLM Dependent Variable: bounce_time
No. Observations: 480     Method:             REML       
No. Groups:       8       Scale:              74.7350    
Min. group size:  60      Likelihood:         -1733.0397 
Max. group size:  60      Converged:          Yes        
Mean group size:  60.0                                   
---------------------------------------------------------
             Coef.  Std.Err.   z    P&gt;|z|  [0.025  0.975]
---------------------------------------------------------
Intercept   201.316    5.175 38.902 0.000 191.174 211.459
age_scaled    0.136    0.612  0.221 0.825  -1.065   1.336
Group Var   212.999   13.382                             
=========================================================
</pre></div>
</div>
</div>
</div>
<p>In this summary of the model, we can clearly see that the <code class="docutils literal notranslate"><span class="pre">age_scaled</span></code> is having a more noticable impact than in the fixed model earlier (coefficient of 0.136 rather than 0.048), however, importantly it is still not significantly different to 0, with the 95% interval for this coefficient spanning -1.065 - 1.336.</p>
<p>And let’s look at the predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and let&#39;s plot the predictions</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">performance</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">values</span>
<span class="n">performance</span><span class="p">[</span><span class="s2">&quot;age_scaled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">age_scaled</span>
<span class="n">performance</span><span class="p">[</span><span class="s2">&quot;predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fittedvalues</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;predicted&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;residuals&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">performance</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x7f0c757ef668&gt;
</pre></div>
</div>
<img alt="../../_images/mixed-models-2_51_1.png" src="../../_images/mixed-models-2_51_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">residplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;age_scaled&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;residuals&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">performance</span><span class="p">,</span> <span class="n">lowess</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Observed - Prediction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_52_0.png" src="../../_images/mixed-models-2_52_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and let&#39;s store the rmse</span>
<span class="n">y_predict</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fittedvalues</span>
<span class="n">RMSE</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">y</span><span class="o">-</span><span class="n">y_predict</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mixed&quot;</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">]</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Method</th>
      <th>RMSE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Linear Regression</td>
      <td>14.928334</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Fixed</td>
      <td>8.563396</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Mixed</td>
      <td>8.563948</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Huh, that’s strange - it’s very similar. In fact the residuals plot looks alomst identical to the previous one where we were treating the county as a fixed effect. Why?</p>
<p>Well, have a think about what we have actually just implemented. All we have done is say in the last one that the county has a randome intercept, but the same slope. This is very similar to the fixed effect approach, where county was included as a term that would impact the intercept. All we have changed is sayng that the intercepts for each county are probably drawn from a similar distribution. To ensure that each county has its own random slope we need to include this in our random effects forumla, like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct our model, but this time we will have a random interecept AND a random slope with respect to age</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">mixedlm</span><span class="p">(</span><span class="s2">&quot;bounce_time ~ age_scaled&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">],</span> <span class="n">re_formula</span><span class="o">=</span><span class="s2">&quot;~age_scaled&quot;</span><span class="p">)</span>
<span class="n">mdf</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               Mixed Linear Model Regression Results
====================================================================
Model:                 MixedLM    Dependent Variable:    bounce_time
No. Observations:      480        Method:                REML       
No. Groups:            8          Scale:                 72.8722    
Min. group size:       60         Likelihood:            -1733.3946 
Max. group size:       60         Converged:             No         
Mean group size:       60.0                                         
--------------------------------------------------------------------
                        Coef.  Std.Err.   z    P&gt;|z|  [0.025  0.975]
--------------------------------------------------------------------
Intercept              202.140    8.356 24.190 0.000 185.762 218.518
age_scaled               0.161    1.196  0.134 0.893  -2.184   2.505
Group Var              558.143                                      
Group x age_scaled Cov -51.614                                      
age_scaled Var           8.621                                      
====================================================================
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
/opt/conda/lib/python3.6/site-packages/statsmodels/regression/mixed_linear_model.py:2026: ConvergenceWarning: Gradient optimization failed.
  warnings.warn(msg, ConvergenceWarning)
/opt/conda/lib/python3.6/site-packages/statsmodels/regression/mixed_linear_model.py:2066: ConvergenceWarning: The Hessian matrix at the estimated parameter values is not positive definite.
  warnings.warn(msg, ConvergenceWarning)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and let&#39;s plot the predictions</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">performance</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">values</span>
<span class="n">performance</span><span class="p">[</span><span class="s2">&quot;age_scaled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">age_scaled</span>
<span class="n">performance</span><span class="p">[</span><span class="s2">&quot;predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fittedvalues</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lmplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;predicted&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;residuals&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">performance</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x7f0c757e7978&gt;
</pre></div>
</div>
<img alt="../../_images/mixed-models-2_56_1.png" src="../../_images/mixed-models-2_56_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">residplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;age_scaled&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;residuals&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">performance</span><span class="p">,</span> <span class="n">lowess</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Observed - Prediction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/mixed-models-2_57_0.png" src="../../_images/mixed-models-2_57_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and let&#39;s store the rmse</span>
<span class="n">y_predict</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fittedvalues</span>
<span class="n">RMSE</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">y</span><span class="o">-</span><span class="n">y_predict</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mixed_Random_Slopes&quot;</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">]</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Method</th>
      <th>RMSE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Linear Regression</td>
      <td>14.928334</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Fixed</td>
      <td>8.563396</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Mixed</td>
      <td>8.563948</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Mixed_Random_Slopes</td>
      <td>8.475248</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<hr class="docutils" />
<p>So our mixed model with the random slopes is now performing much better, with our residuals much better ditributed. Crucially though, we can see that age does not impact the bounce rate, with the confidence intervals for the gradient with respect to age spanning -2.184 - 2.505 after we have controlled for the random variation caused by the county properly, i.e. with a random slope and intercept.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--------------------------------------------------------------------------</span>
                              <span class="n">Coef</span><span class="o">.</span>  <span class="n">Std</span><span class="o">.</span><span class="n">Err</span><span class="o">.</span>   <span class="n">z</span>    <span class="n">P</span><span class="o">&gt;|</span><span class="n">z</span><span class="o">|</span>  <span class="p">[</span><span class="mf">0.025</span>  <span class="mf">0.975</span><span class="p">]</span>
<span class="o">--------------------------------------------------------------------------</span>
<span class="n">Intercept</span>                    <span class="mf">202.140</span>    <span class="mf">8.356</span> <span class="mf">24.190</span> <span class="mf">0.000</span> <span class="mf">185.762</span> <span class="mf">218.518</span>
<span class="n">age_scaled</span>                     <span class="mf">0.161</span>    <span class="mf">1.196</span>  <span class="mf">0.134</span> <span class="mf">0.893</span>  <span class="o">-</span><span class="mf">2.184</span>   <span class="mf">2.505</span>
<span class="n">Intercept</span> <span class="n">RE</span>                 <span class="mf">558.143</span>                              
<span class="n">Intercept</span> <span class="n">RE</span> <span class="n">x</span> <span class="n">age_scaled</span> <span class="n">RE</span> <span class="o">-</span><span class="mf">51.614</span>                                 
<span class="n">age_scaled</span> <span class="n">RE</span>                  <span class="mf">8.621</span>                                      
<span class="o">==========================================================================</span>
</pre></div>
</div>
<p>What we have seen in our data was that individuals in certain counties took longer on the website, and that they happened to also be old. However, to get to this distinction we had to first treat county as a random effect. But what about location? Eh? Forgot about that. See the take home material 4. for that one.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="wrap-up">
<h2>5. Wrap Up<a class="headerlink" href="#wrap-up" title="Permalink to this headline">¶</a></h2>
<p>Well done for getting this far! You know have an understanding of what a mixed effect model is, and how it alters the coefficients within regression models so you account for variation stemming from random variables. Reward yourselves with pizza!!!</p>
<p><img alt="" src="https://i.imgflip.com/2gu0c8.jpg" /></p>
<p>… or if you fancy there is some more material for those interested.</p>
</div>
<div class="section" id="take-home-challenges">
<h2>Take home challenges<a class="headerlink" href="#take-home-challenges" title="Permalink to this headline">¶</a></h2>
<div class="section" id="test-the-initial-linear-regression-was-significant">
<h3>1. Test the initial linear regression was significant<a class="headerlink" href="#test-the-initial-linear-regression-was-significant" title="Permalink to this headline">¶</a></h3>
<p>In section 2 we constructed a linear regression model on our data. It looked as if the coefficient for the gradient was significant, i.e. there was in fact a positive relationship between age and bounce time. However, to be sure we could use a statistical test, such as the <strong>t.test</strong> to test this. This can be often useful and can be used to produce <strong>p.values</strong> which gives us a measure of how confident we are about something. In this we will test whether the intercept and mean are significantly different from 0.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="c1"># construct our linear regression model</span>
<span class="n">lm</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">age</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bounce_time</span>

<span class="c1"># fit our model to the data</span>
<span class="n">lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># let&#39;s get our fitted parameters for the intercept and coefficient and what our predictions are</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span><span class="n">lm</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># and let&#39;s simulate some new data for the model and then compare what the error is for these </span>
<span class="n">newx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Constant&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))})</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">MSE</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">predictions</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newx</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">newx</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

<span class="c1"># and whats the variance, standard deviation, t values and p-values</span>
<span class="n">var_b</span> <span class="o">=</span> <span class="n">MSE</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">newx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">newx</span><span class="p">))</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span>
<span class="n">sd_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_b</span><span class="p">)</span>
<span class="n">ts_b</span> <span class="o">=</span> <span class="n">params</span><span class="o">/</span> <span class="n">sd_b</span>
<span class="n">p_values</span> <span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="p">),(</span><span class="nb">len</span><span class="p">(</span><span class="n">newx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ts_b</span><span class="p">]</span>

<span class="c1"># and let&#39;s group it together</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">]</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">summary</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">],</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Coefficients&quot;</span><span class="p">],</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Standard Errors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">sd_b</span><span class="p">]</span>
<span class="n">summary</span><span class="p">[</span><span class="s2">&quot;t values&quot;</span><span class="p">],</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Probabilites&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts_b</span><span class="p">,</span><span class="n">p_values</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>       names  Coefficients      ...         t values  Probabilites
0  intercept    187.409130      ...       112.950956           0.0
1        age      0.275529      ...         9.196758           0.0

[2 rows x 5 columns]
</pre></div>
</div>
</div>
</div>
<p>Yup we can see that the probability that the intercept and age are not equal to 0 is is 0 (in fact it’s &lt;2e-16 but hey ho).</p>
</div>
<div class="section" id="calculate-the-rmse-for-the-individual-linear-regressions">
<h3>2. Calculate the RMSE for the individual linear regressions<a class="headerlink" href="#calculate-the-rmse-for-the-individual-linear-regressions" title="Permalink to this headline">¶</a></h3>
<p>In section 3 we constructed mutliple linear regression models on our data. But how did they perform? Try and estimate the RMSE for each model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">counties</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">counties</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">counties</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
    <span class="n">county</span> <span class="o">=</span> <span class="n">counties</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">age</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">county</span> <span class="o">==</span> <span class="n">county</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bounce_time</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">county</span> <span class="o">==</span> <span class="n">county</span><span class="p">]</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">predict</span><span class="p">)</span>
    <span class="n">rms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>23.914852863665146
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="add-in-locations-for-the-mixed-effect-model">
<h3>3. Add in locations for the mixed effect model<a class="headerlink" href="#add-in-locations-for-the-mixed-effect-model" title="Permalink to this headline">¶</a></h3>
<p>In section 4 we constructed our mixed effect model, treating county as a random effect. However, what about location? This will really improve our predictions.</p>
<p><strong>Hint: You will need to create a new variable that considers how the random effects are nested. For example there is nothing important about the locations a, b, and c that link location a in London with that in Essex. Therefore explicitly nest them</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct our model, with our county now shown as a group</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;location_county&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">]</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="n">md</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">mixedlm</span><span class="p">(</span><span class="s2">&quot;bounce_time ~ age_scaled&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;location_county&quot;</span><span class="p">],</span> <span class="n">re_formula</span><span class="o">=</span><span class="s2">&quot;~age_scaled&quot;</span><span class="p">)</span>
<span class="n">mdf</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mdf</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               Mixed Linear Model Regression Results
====================================================================
Model:                 MixedLM    Dependent Variable:    bounce_time
No. Observations:      480        Method:                REML       
No. Groups:            24         Scale:                 23.7951    
Min. group size:       20         Likelihood:            -1504.9092 
Max. group size:       20         Converged:             No         
Mean group size:       20.0                                         
--------------------------------------------------------------------
                        Coef.  Std.Err.   z    P&gt;|z|  [0.025  0.975]
--------------------------------------------------------------------
Intercept              201.493    3.448 58.439 0.000 194.735 208.250
age_scaled               0.151    0.393  0.385 0.700  -0.618   0.921
Group Var              282.798   21.303                             
Group x age_scaled Cov  -8.363    2.488                             
age_scaled Var           0.389    0.495                             
====================================================================
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.6/site-packages/statsmodels/base/model.py:508: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  &quot;Check mle_retvals&quot;, ConvergenceWarning)
/opt/conda/lib/python3.6/site-packages/statsmodels/regression/mixed_linear_model.py:2026: ConvergenceWarning: Gradient optimization failed.
  warnings.warn(msg, ConvergenceWarning)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># and let&#39;s store the rmse</span>
<span class="n">y_predict</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fittedvalues</span>
<span class="n">RMSE</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(((</span><span class="n">y</span><span class="o">-</span><span class="n">y_predict</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Nested_Mixed&quot;</span><span class="p">,</span> <span class="n">RMSE</span><span class="p">]</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Method</th>
      <th>RMSE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Linear Regression</td>
      <td>14.928334</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Fixed</td>
      <td>8.563396</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Mixed</td>
      <td>8.563948</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Nested_Mixed</td>
      <td>4.790665</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="glm-mixed-effect-for-logistic">
<h3>4. glm mixed effect for logistic<a class="headerlink" href="#glm-mixed-effect-for-logistic" title="Permalink to this headline">¶</a></h3>
<p>Wait, there’s more data! Yup. In the other dataset, “data2.csv”, you will know whether the individual chose a recipe from the website. So that’s then a binary outcome. So wouldn’t it be nice to fit a logistic regression, with the mixed effects?</p>
<p>Yes it would! Fortunately, there is also a <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> for that that allows you to construct generalised linear mixed models, or GLMMs, so you can then specify what the relationship is between your data and the response (logistic).</p>
<p>https://www.statsmodels.org/stable/generated/statsmodels.genmod.bayes_mixed_glm.BinomialBayesMixedGLM.html#statsmodels.genmod.bayes_mixed_glm.BinomialBayesMixedGLM</p>
<p>And if you want an example of how it’s implemented, and some alternative ways of doing GLMMs, check out this great repo:</p>
<p>https://github.com/junpenglao/GLMM-in-Python</p>
</div>
<div class="section" id="read-on-the-strengths-of-a-mutlievel-mixed-effects-modelling-vs-random-forests">
<h3>5. Read on the strengths of a mutlievel (mixed-effects) modelling vs random forests.<a class="headerlink" href="#read-on-the-strengths-of-a-mutlievel-mixed-effects-modelling-vs-random-forests" title="Permalink to this headline">¶</a></h3>
<p>Still here?? Really, well here is some reading by the godfather himself, Andrew Gelman, detailing what multilevel models can do:</p>
<p>http://www.stat.columbia.edu/~gelman/research/published/multi2.pdf</p>
<p>And for those who want to know how this stacks up against random forests:</p>
<p>https://epub.ub.uni-muenchen.de/39955/1/TR.pdf</p>
</div>
<div class="section" id="compare-performance-to-random-forest">
<h3>6. Compare performance to random forest<a class="headerlink" href="#compare-performance-to-random-forest" title="Permalink to this headline">¶</a></h3>
<p>Seriously? Take a break…</p>
<p>… or how about comparing the performance of the mixed-effect models against a random forest for this dataset?</p>
<p>… nah just have pizza.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters/15"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Todd Gureckis<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>